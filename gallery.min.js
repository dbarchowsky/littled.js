!function(a){var b={allowSorting:!0,editThumbnailURL:"_ajax/images/upload_image.php",linkThumbnailURL:"_ajax/images/set_thumbnail.php",unlinkThumbnailURL:"_ajax/images/unlink_thumbnail.php",deleteThumbnailURL:"_ajax/images/del_image.php",albumListingsURL:"_ajax/images/album_listings.php",galleryListingsURL:"_ajax/images/gallery_listings.php",albumContainer:"",errorContainer:".alert-error:first",statusContainer:".alert-info:first",navigationContainer:".page-links-container",albumFiltersSelector:".album-filters",dialogContainer:"#globalDialog",csrfSelector:"#csrf-token",imageDialogClass:"gallery-dialog",postGalleryUpdateCB:null,dom:{album_container:".album-listings",album_filters:".album-filters form:first",gallery_container:".gallery-listings",gallery_filters:".listings-filters",page_error_container:".alert-error:first",error_container:".alert-error",status_container:"alert-info:first",dialog_container:"tk",filters_form:".album-filters form:first",csrf_selector:"#csrf-token"},listings:{album_listings_uri:"tk",gallery_listings_uri:"tk",album_container:"tk",navigation_container:"tk",album_filters_container:"tk"},thumbnails:{edit_uri:"tk",link_uri:"tk",unlink_uri:"tk",delete_uri:"tk"},edit:{id_param:"abid",title_param:"abti",slug_param:"AlbumSlug",class_param:"type",class_key:"class",csrf_key:"csrf",validate_slug_uri:"/_ajax/utils/validate_slug.php"},keys:{keyword_filter:"flkw",record_id:"id",content_type_id:"tid",parent_id:"pid",album_page:"p",gallery_page:"ip",operation:"op",csrf:"csrf"},previews:{rolloverSelector:".gal-ro",className:"tip-darkgray",alignTo:"target",alignX:"right",alignY:"center",offsetX:8,followCursor:!0,content:function(){var b=a(".tooltip-content",a(this).parent().parent());return b.length<1&&updateCallback("Preview unavailable!"),b.html()}}},c={retrieveGallery:function(c){var d=a.extend(!0,{},b,c||{});return this.each(function(){var e=a(this),f=e.data(d.keys.parent_id),g=e.data(d.keys.content_type_id);if(!f)return a(d.dom.page_error_container).littled("displayError","Parent not set."),void 0;if(!g)return a(d.dom.page_error_container).littled("displayError","Content type not set."),void 0;d.hasOwnProperty("galleryFilters")===!1&&(d.galleryFilters={});var h=a.extend({},d.galleryFilters,{pid:f,tid:g});h[d.edit.csrf_key]=a(d.csrfSelector).html(),a.littled.retrieveContentOperations(g,function(g){var i=g.listings_uri||a.littled.getRelativePath()+b.galleryListingsURL;a.post(i,h,function(b){return b.error?(a(d.dom.page_error_container).littled("displayError",b.error),void 0):(e.html(a.littled.htmldecode(b.content)),e.galleries("bindGalleryHandlers",c),d.hasOwnProperty("animate")&&d.animate===!0&&a("tr.gallery-row[data-id="+f+"]").galleries("animateGalleryToggle",c),void 0)},"json").success(function(){d.postGalleryUpdateCB&&d.postGalleryUpdateCB.apply(this,arguments)}).fail(function(b){0!==b.status&&a(d.dom.page_error_container).littled("ajaxError",b)})})})},toggleGallery:function(c,d){var e=a.extend(!0,{},b,d||{}),f=a(this).data("id"),g=a(this).button("option","icons"),h=a("tr.gallery-row[data-id="+f+"]");if(h.length<1)return a(e.dom.page_error_container).littled("displayError","Gallery could not be located."),void 0;if("ui-icon-expand"===g.primary){var i=a(e.dom.gallery_container+" table:first",h);if(i.length<1){var j,k=a(e.dom.album_filters);k.length>0&&(j=k.serializeObject({},["pl","next","filt"]));var l=a.extend({},{pid:f},j||{});a(e.dom.gallery_container,h).galleries("retrieveGallery",{galleryFilters:l,animate:!0})}else{var m=a(e.dom.gallery_container,h);m.hasClass("functional")===!1&&m.galleries("bindGalleryHandlers"),h.galleries("animateGalleryToggle",d),h.galleries("configureSorting",d)}}else h.galleries("animateGalleryToggle",d)},animateGalleryToggle:function(c){var d=a.extend(!0,{},b,c||{});return this.each(function(){var b=a(this).data("id"),c=a("#toggle-"+b+"-btn"),e=c.button("option","icons");if("ui-icon-expand"===e.primary)c.button("option","icons",{primary:"ui-icon-collapse"}),a(this).show(),a(d.dom.gallery_container,a(this)).slideToggle("slow");else{a(d.dom.gallery_container,a(this)).slideToggle("",function(){a(this).hide()});var f=a(d.dom.gallery_container+" table:first",a(this));f.length>0&&f.hasClass("ui-sortable")&&f.sortable("destroy"),c.button("option","icons",{primary:"ui-icon-expand"})}})},bindAlbumListingsHandlers:function(d){var e=a.extend(!0,{},b,d||{});return this.each(function(){a(this).unbind("contentUpdate",c.updateAlbumListingsHandlers).bind("contentUpdate",e,c.updateAlbumListingsHandlers).keywords("bindListingsHandlers").off("click","tr.list",c.toggleListHighlight).on("click","tr.list",c.toggleListHighlight).off("click","tr.list-alt",c.toggleListHighlightAlt).on("click","tr.list-alt",c.toggleListHighlightAlt).off("click",".alb-nav",c.gotoAlbumPage).on("click",".alb-nav",d,c.gotoAlbumPage).off("click",".toggle-pages-btn",c.toggleGallery).on("click",".toggle-pages-btn",c.toggleGallery).off("click",".add-page-btn",c.editImage).on("click",".add-page-btn",d,c.editImage).off("click",".add-page-link",c.editImage).on("click",".add-page-link",d,c.editImage).off("click",".update-cache-btn",a.littled.updateCache).on("click",".update-cache-btn",{errorContainer:e.dom.error_container,statusContainer:e.statusContainer},a.littled.updateCache).off("dblclick",".inline-edit-cell",c.editCell).on("dblclick",".inline-edit-cell",d,c.editCell).off("galleryLoaded",".pages-row",c.retrieveGallery).on("galleryLoaded",".pages-row",d,c.retrieveGallery),e.allowSorting===!0&&a(this).galleries("bindAlbumResorting",d),a(".details-btn",a(this)).iconButton("details"),a(".edit-btn",a(this)).iconButton("edit"),a(".print-btn",a(this)).iconButton("print"),a(".trash-btn",a(this)).iconButton("trash"),a(".preview-btn",a(this)).iconButton("link"),a(".toggle-pages-btn",a(this)).iconButton("expand"),a(".add-page-btn",a(this)).iconButton("addchild"),a(".update-cache-btn",a(this)).iconButton("cache"),a(e.previews.rolloverSelector,a(this)).poshytip(e.previews),a(".img-details-link",a(this)).formDialog({dialogClass:e.imageDialogClass,dom:{listings_container:e.dom.album_container}}),a(".trash-btn",a(this)).formDialog({dialogClass:"ui-dialog-delete",dom:{listings_container:e.dom.album_container}}),a(e.dom.gallery_container).addClass("hidden")})},updateAlbumListingsHandlers:function(b){a(this).galleries("bindAlbumListingsHandlers",b.data||{})},bindGalleryHandlers:function(d){var e=a.extend(!0,{},b,d||{});return this.each(function(){a(this).off("contentUpdate",c.updateGalleryHandlers).on("contentUpdate",e,c.updateGalleryHandlers).galleries("bindFilterElementsHandlers",d).galleries("configureSorting",d).galleries("bindImageOverlayHandlers",d).keywords("bindListingsHandlers",d).off("dblclick",".inline-edit-cell",c.editCell).on("dblclick",".inline-edit-cell",c.editCell).off("click",".add-img-btn",c.editImage).on("click",".add-img-btn",d,c.editImage).off("click",".edit-img-btn",c.editImage).on("click",".edit-img-btn",d,c.editImage).off("click",".update-cache_btn",a.littled.updateCache).on("click",".update-cache_btn",{errorContainer:e.dom.error_container,statusContainer:e.statusContainer},a.littled.updateCache).off("click",".gal-nav",c.gotoGalleryPage).on("click",".gal-nav",d,c.gotoGalleryPage).addClass("functional");var b={dialogClass:e.imageDialogClass,formLoadCB:function(){var b=a(e.dialogContainer+":visible");b.length<1||a(".image-detail").on("click",function(a){a.preventDefault(),b.formDialog("close")})},dom:{listings_container:e.dom.gallery_container}};a(".img-details-btn",a(this)).iconButton("details").formDialog(b),a(".img-details-link",a(this)).formDialog(b),a(".add-img-btn",a(this)).iconButton("addchild"),a(".edit-img-btn",a(this)).iconButton("edit"),a(".delete-img-btn",a(this)).iconButton("trash").formDialog({dialogClass:"ui-dialog-delete",dom:{listings_container:e.dom.gallery_container},callbacks:{update_content:c.updateGalleryListingsContent}}),jQuery().poshytip&&a(e.previews.rolloverSelector,a(this)).poshytip(e.previews),a(".datepicker",a(this)).datepicker()})},updateGalleryHandlers:function(c){var d=a.extend(!0,{},b,c||{});a(this).galleries("bindGalleryHandlers"),d.postGalleryUpdateCB&&d.postGalleryUpdateCB.apply(this,arguments)},updateGalleryListingsContent:function(c){var d=a.extend(!0,{},b,c.settings||{}),e=d.dom.gallery_container+"[data-pid="+c.parent_id+"]";c.settings={dom:{listings_container:e}},a(e).listings("updateListingsContent",c)},bindImageOverlayHandlers:function(d){var e=a.extend(!0,{},b,d||{});return this.each(function(){a(this).off("contentUpdate",c.updateImageOverlayHandlers).on("contentUpdate",e,c.updateImageOverlayHandlers).off("click",".img-upload-btn",c.updateThumbnail).on("click",".img-upload-btn",d,c.updateThumbnail).off("click",".sel-galltn-btn",c.updateThumbnail).on("click",".sel-galltn-btn",d,c.updateThumbnail).off("click",".add-img-btn",c.editImage).on("click",".add-img-btn",d,c.editImage).off("click",".gallery-edit",c.bindGalleryEditButtons).off("dblclick",".gallery-edit",c.detailsDialog).on("click",".gallery-edit",d,c.bindGalleryEditButtons).on("dblclick",".gallery-edit",d,c.detailsDialog).off("click",".gallery-tn-container",c.bindThumbnailEditButtons).off("dblclick",".gallery-tn-container",c.detailsDialog).on("click",".gallery-tn-container",d,c.bindThumbnailEditButtons).on("dblclick",".gallery-tn-container",d,c.detailsDialog),a(".img-upload-btn",a(this)).button(),a(".sel-galltn-btn",a(this)).button(),a(".add-img-btn",a(this)).iconButton("addchild")})},updateImageOverlayHandlers:function(b){a(this).galleries("bindImageOverlayHandlers",b.data||{})},bindGalleryEditButtons:function(){var b=a("#img-overlay-btns");if(!(b.length<1)){var d=a(this);d.addClass("active-edit"),a("#edit-overlay-btn").off("click",c.editImage).on("click",c.editImage),a("#edit-overlay-btn").data("id",d.data("id")),a("#edit-overlay-btn").data("pid",d.data("pid")),a("#edit-overlay-btn").data("tid",d.data("tid")),a("#del-overlay-btn").data("id",d.data("id")),a("#del-overlay-btn").data("pid",d.data("pid")),a("#del-overlay-btn").data("tid",d.data("tid")),a("#del-overlay-btn").formDialog({dialogClass:"ui-dialog-delete"});var e=d.offset();b.css("top",e.top+6).css("left",e.left+6).show(),setTimeout(function(){d.removeClass("active-edit"),a("#edit-overlay-btn").off("click",c.editImage),a("#del-overlay-btn").formDialog("cancel"),b.hide()},4e3)}},bindThumbnailEditButtons:function(b){b.preventDefault();var d=b.data||{},e=a("#tn-overlay-btns");if(!(e.length<1)){a(this).addClass("active-edit");var f=a("#edit-galltn-btn"),g=a("#del-galltn-btn");f.on("click",d,c.updateThumbnail),g.on("click",d,c.updateThumbnail),f.data("id",a(this).data("id")),f.data("pid",a(this).data("pid")),f.data("tid",a(this).data("tid")),f.data("op",a(this).data("op")),f.data("rand",a(this).data("rand")),g.data("id",a(this).data("id")),g.data("pid",a(this).data("pid")),g.data("tid",a(this).data("tid")),g.data("op","del-"+a(this).data("op"));var h=a(this).offset();e.css("top",h.top+6).css("left",h.left+6).show();var i=a(this);setTimeout(function(){i.removeClass("active-edit"),f.off("click",c.updateThumbnail),g.off("click",c.updateThumbnail),e.hide()},4e3)}},bindSlugWatch:function(d){var e=a.extend(!0,{},b,d||{});return this.on("blur",e,c.validateSlug)},validateSlug:function(c){var d=a.extend(!0,{},b,c.data||{});a(this).closest("div").children(".alert-error:visible").fadeOut("fast");var e=a(this).closest("form"),f={};f[d.edit.csrf_key]=a(d.csrfSelector).html(),f[d.edit.id_param]=a('input[name="'+d.edit.id_param+'"]',e).val(),f[d.edit.title_param]=a('input[name="'+d.edit.title_param+'"]',e).val(),f[d.edit.slug_param]=a('input[name="'+d.edit.slug_param+'"]',e).val(),f[d.edit.class_key]=a('input[name="'+d.edit.class_param+'"]',e).val(),f[d.edit.id_param]||a(this).attr("name")===d.edit.slug_param&&(f[d.edit.title_param]=f[d.edit.slug_param],f[d.edit.slug_param]=""),a.post(d.edit.validate_slug_uri,f,function(b){if(b.content){var c=a('input[name="'+d.edit.slug_param+'"]',e);c.val(b.content)}if(b.error)if(b.content){var f=c.closest("div"),g=a(".alert-error",f);if(g.length<1){var g=a('<div class="alert alert-error hidden"></div>');f.prepend(g)}g.html(b.error),g.fadeIn("slow")}else a(d.dom.error_container).littled("displayError",b.error);else;},"json").fail(function(b){a(d.dom.error_container).littled("ajaxError",b)})},editImage:function(b){b.preventDefault(),b.hasOwnProperty("data")&&delete b.data;var d=c.getListingsSelector.apply(this,b.data);b.data={dom:{listings_container:d}},a(this).formDialog("open",b)},getListingsSelector:function(c){var d=a.extend(!0,{},b,c||{});return d.dom.gallery_container+"[data-"+d.keys.parent_id+"="+a(this).data(d.keys.parent_id)+"]"},editCell:function(b){b.stopPropagation(),a(this).listings("editCell",b)},updateThumbnail:function(d){d.preventDefault();var e=d.data||{},f=a.extend(!0,{},b,e),g=a(this).data("op"),h=a(this).formDialog("retrieveFormFilters",d.data||{});if("upload"!==g&&"del-upload"!==g&&void 0===h.pid||void 0===h.tid)return a(f.dom.error_container).littled("displayError","Gallery properties not set."),void 0;h[f.edit.csrf_key]=a(f.csrfSelector).html();var i=c.getThumbnailURI(g,f);a.post(i,h,function(b){var d={formLoadCB:c.displayThumbnailDialog};0===g.indexOf("del")&&(d.dialogClass="ui-dialog-delete"),b.settings=a.extend(!0,{},e,d),a(f.dialogContainer).formDialog("display",b)},"json").fail(function(b){a(f.dom.error_container).littled("ajaxError",b)})},displayThumbnailDialog:function(d){var e=a.extend(!0,{},b,d||{});a(e.dialogContainer+" .dlg-commit-btn").off("click"),a(e.dialogContainer+" .dlg-commit-btn").on("click",d,c.commitThumbnailUpdate)},commitThumbnailUpdate:function(d){d.preventDefault();var e,f=a.extend(!0,{},b,d.data||{}),g=a(f.dialogContainer+" form:first"),h=a("input[name=op]",g);if(h.length&&(e=h.val()),!e)return a(f.dom.error_container).littled("displayError","Operation not specified."),void 0;var i=c.getThumbnailURI(e,f);"select"===e?a.post(i,g.serializeObject(),function(a){a.options=d.data||{},c.processThumbnailUpdate(a)},"json").fail(function(b){a(f.dom.error_container).formDialog("ajaxError",b)}):g.ajaxSubmit({type:"post",url:i,dataType:"json",success:function(a){a.options=d.data||{},c.processThumbnailUpdate(a)},error:function(b){a(f.dom.error_container).littled("ajaxError",b)}})},processThumbnailUpdate:function(c){var d=a.extend(!0,{},b,c.options||{});if(c.error)return a(d.dom.error_container).littled("displayError",c.error),void 0;if(a(d.dialogContainer).formDialog("close"),c.container_id){var e=a(c.container_id);e.length&&(e.html(a.littled.htmldecode(c.content)),a(c.container_id).galleries("bindImageOverlayHandlers"))}},getThumbnailURI:function(c,d){var e=a.extend(!0,{},b,d||{});switch(c){case"upload":case"edit":return a.littled.getRelativePath()+e.editThumbnailURL;case"link":case"select":return a.littled.getRelativePath()+e.linkThumbnailURL;case"unlink":case"del-link":return a.littled.getRelativePath()+e.unlinkThumbnailURL;case"delete":case"del-upload":return a.littled.getRelativePath()+e.deleteThumbnailURL;default:return a(e.dom.error_container).littled("displayError","Unhandled operation."),""}},deleteRecord:function(){},gotoAlbumPage:function(c){c.preventDefault();var d=c.data||{},e=a.extend(!0,{},b,d),f={};f[e.keys.album_page]=a(this).data(e.keys.album_page),f[e.keys.content_type_id]=a(e.dom.album_container+" table:first").data(e.keys.content_type_id),f[e.keys.parent_id]=a(e.dom.album_container+" table:first").data(e.keys.parent_id),a(".sm-process-wheel").addClass("sm-active-wheel"),a("#status-container").fadeOut("fast");var g=a(e.dom.album_filters).littled("collectFormDataWithCSRF",c.data||{},f);a.littled.retrieveContentOperations(g[e.keys.content_type_id],function(b){if(b.error)return a(e.dom.error_container).littled("displayError",b.error),void 0;var c=a.littled.getRelativePath()+e.albumListingsURL;b.listings_uri&&(c=b.listings_uri),a.ajax({type:"post",url:c,data:g,dataType:"json"}).success(function(b){b.settings=d,b.page=f[e.keys.album_page],a(e.dom.album_container).galleries("updateAlbumContent",b)}).fail(function(b){a(e.dom.error_container).littled("ajaxError",b)})})},updateAlbumContent:function(c){var d=a.extend(!0,{},b,c.settings||{});if(c.error)return a(d.dom.error_container).littled("displayError",c.error),void 0;var e=c.hasOwnProperty("page")?c.page:1;e||(e=1),a(".sm-process-wheel").removeClass("sm-active-wheel");var f=a.Event("contentUpdate");f.data=c.settings||{},a(d.dom.album_container).html(a.littled.htmldecode(c.content)),a(d.dom.album_container).data("p",e).trigger(f)},gotoGalleryPage:function(c){c.preventDefault();var d=c.data||{},e=a.extend(!0,{},b,d),f=a(this).parents(e.dom.gallery_container+":first"),g=a(e.dom.gallery_filters,f),h={};h[e.keys.parent_id]=f.data(e.keys.parent_id),h[e.keys.album_page]=a(this).data(e.keys.album_page),a("input[name="+e.keys.gallery_page+"]",g).val(h[e.keys.album_page]);var i=a.extend({},h,a("input, select",g).serializeObject());f.galleries("retrieveGallery",a.extend(!0,{},d,{galleryFilters:i,animate:!1}))},configureSorting:function(c){a.extend(!0,{},b,c||{});return this.each(function(){var b=a("table:first",a(this));b.length>0?b.sortable({items:"tr.page-row",update:function(b,c){a(this).resort("resort",b,c)}}):a(this).is("div")&&a(this).sortable({items:".page-cell",update:function(b,c){a(this).resort("resort",b,c)}})})},bindFilterElementsHandlers:function(d){var e=a.extend(!0,{},b,d||{});return this.each(function(){var b=a(".gallery-page-nav:first",a(this));a("input[name="+e.keys.keyword_filter+"]",b).keypress(function(c){var d=window.event?window.event.keyCode:c.which;13===d&&a(".gallery-filter-btn:first",b).trigger("click")}),a(".gallery-filter-btn:first",b).button().off("click",c.submitGalleryFilters).on("click",d,c.submitGalleryFilters)})},bindAlbumResorting:function(d){var e=a.extend(!0,{},b,d||{});return this.each(function(){var b=!1,f=a(e.dom.filters_form);if(f.length>0){var g=f.serializeObject();b=c.hasFilteredListings(g)}b===!1&&a("table:first",a(this)).resort("bindResort",d)})},submitGalleryFilters:function(c){c.preventDefault();var d=c.data||{},e=a.extend(!0,{},b,c.data||{}),f=a(this).closest("form"),g=a("input, select",f).serializeObject();g.hasOwnProperty(e.keys.gallery_page)&&delete g[e.keys.gallery_page],f.closest(e.dom.gallery_container).galleries("retrieveGallery",a.extend(!0,{},d,{galleryFilters:g,animate:!1}))},hasFilteredListings:function(b){var c,d=a.extend({},{p:"",pl:"",filt:"",ifilt:"",next:"",inext:"",ip:"",ipl:""});for(c in b)if(b.hasOwnProperty(c)&&d.hasOwnProperty(c)===!1&&Object.prototype.hasOwnProperty.call(b,c))return b[c]?!0:!1;return!1},toggleListHighlight:function(){a(this).toggleClass("md")},toggleListHighlightAlt:function(){a(this).toggleClass("md-alt")},bindDialogHandlers:function(){return this.each(function(){a(".dlg-commit-btn",a(this)).button().on("click",cb),a(".dlg-cancel-btn",a(this)).button().on("click",LITTLED.cancel),a(".datepicker",a(this)).datepicker()})}};a.fn.galleries=function(b){return c[b]?c[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?(a.error("Method "+b+" does not exist on jQuery.galleries."),!1):c.init.apply(this,arguments)}}(jQuery);