!function(a){var b={site_label:"",album_type:"",layout:"",uris:{page_set:"/_ajax/book-viewer/page-set.php"},dom:{album_container:".album-container",page_set:".page-set",page_previews:".page-previews",book_previews:".book-previews",left_page:".left-page",right_page:".right-page",page_thumbnail:".page-tn",page_title:".page-title",page_number:".page-number",page_navigation:".page-links-container",prev_page_button:".prev-pg-btn",next_page_button:".next-pg-btn",minimized_header:".minimized-header",scroll_pane:".scroll-pane",scrollbar:".scroll-bar",scroll_content:".scroll-content",preload:".preload-",error_container:".alert-error",csrf_container:"#csrf-token"},keys:{record_id:"id",operation:"op",page:"p",type:"type","class":"class",csrf:"csrf"},layouts:{one_page:"1-up",two_page:"2-up"}},c={bindBookSetHandlers:function(c){var d=a.extend(!0,{},b,c||{});return this.each(function(){a(d.dom.page_set,a(this)).bookviewer("bindPageSetHandlers",c),a(d.dom.page_navigation,a(this)).bookviewer("bindNavigationHandlers",c),a(d.dom.page_previews,a(this)).bookviewer("bindPagePreviewsHandlers",c),a(d.dom.book_previews,a(this)).bookviewer("bindBookPreviewsHandlers",c)})},bindPageSetHandlers:function(d){var e=a.extend(!0,{},b,d||{});return this.each(function(){a(this).on("click",e.dom.left_page,d,c.changePage).on("click",e.dom.right_page,d,c.changePage)})},bindNavigationHandlers:function(d){var e=a.extend(!0,{},b,d||{});return this.each(function(){a(this).on("click",e.dom.prev_page_button,d,c.changePage).on("click",e.dom.next_page_button,d,c.changePage)})},bindPagePreviewsHandlers:function(d){var e=a.extend(!0,{},b,d||{});return this.bookviewer("initScrollbar",d).on("click",e.dom.page_thumbnail,d,c.changePage)},bindBookPreviewsHandlers:function(a){return this.bookviewer("initScrollbar",a)},bindKeyedNavigation:function(a){return this.on("keydown",a,c.keyNavigation)},changePage:function(d){d.preventDefault();var e=d.data||{},f=a.extend(!0,{},b,e),g=a(this).closest(f.dom.album_container),h={};h[f.keys.record_id]=g.data(f.keys.record_id),h[f.keys.class]=g.data(f.keys.type),h[f.keys.page]=a(this).data(f.keys.page),h[f.keys.operation]=a(this).data(f.keys.operation),h[f.keys.csrf]=a(f.dom.csrf_container).html(),a.ajax({method:"post",url:f.uris.page_set,data:h,dataType:"json"}).success(function(a){a.settings=e,c.updateBookContent(a)}).fail(function(b){a(f.dom.error_container).littled("ajaxError",b)})},updateBookContent:function(d){var e=a.extend(!0,{},b,d.settings||{});if(d.error)return a(e.dom.error_container).littled("displayError",d.error),void 0;if("undefined"!=typeof _gaq&&_gaq.push(["_trackEvent",d.album_type,"Nav",d.page_title]),void 0!==d.gallery&&(!(d.gallery.list.length>1)||d.gallery.list[0].full.path||d.gallery.list[1].full.path)){switch(d.layout){case e.layouts.one_page:c.updateOneUpBookContent(d);break;case e.layouts.two_page:c.updateTwoUpBookContent(d);break;default:return alert("Unhandled layout type."),void 0}a(e.dom.page_number).html(c.formatPageSetLabel(d)),document.title=c.formatDocumentTitle(d);var f=a(e.dom.page_title);f.length>0&&a("img",f).length<1&&f.html(d.page_title),"undefined"!=typeof _gaq&&_gaq.push(["_trackPageview"])}},updateOneUpBookContent:function(c){var d=c.settings||{},e=a.extend(!0,{},b,d);return c.gallery.list[0].full.path?(a(e.dom.page_set+" "+e.dom.right_page).bookviewer("updatePageState",c.gallery.list[0],c.gallery.list[1],d),a(e.dom.page_navigation).bookviewer("updatePageNavigation",c),void 0):(a(e.dom.error_container).littled("displayError","Page image unavailable."),void 0)},updateTwoUpBookContent:function(c){var d=c.settings||{},e=a.extend(!0,{},b,d);c.gallery.list[0].full.path?a(e.dom.page_set+" "+e.dom.left_page).bookviewer("updatePageState",c.gallery.list[0],c.gallery.list[2],d):a(e.dom.page_set+" "+e.dom.left_page).bookviewer("updateAdjacentPageState",c.gallery.list[1],c.gallery.list[2],d),c.gallery.list[1].full.path?a(e.dom.page_set+" "+e.dom.right_page).bookviewer("updatePageState",c.gallery.list[1],c.gallery.list[3],d):a(e.dom.page_set+" "+e.dom.right_page).bookviewer("updateAdjacentPageState",c.gallery.list[0],c.gallery.list[3],d),a(e.dom.page_navigation).bookviewer("updatePageNavigation",c)},formatDocumentTitle:function(c){var d=a.extend(!0,{},b,c.settings||{}),e=c.page_title;return d.site_label&&(e+=" | "+d.album_type+" | "+d.site_label),e},formatPageSetLabel:function(c){var d=a.extend(!0,{},b,c.settings||{}),e="";return c.layout===d.layouts.one_page?c.gallery.list[0].title:(c.gallery.list[0].title&&(e=c.gallery.list[0].title),c.gallery.list[1].title&&(e?e+="/"+c.gallery.list[1].title.replace(/[^\d]/g,""):e=c.gallery.list[1].title),e)},updatePageState:function(c,d,e){var f=a.extend(!0,{},b,e||{});return this.each(function(){var b=a("<img />").prop({src:c.full.path,alt:c.title});a(this).html(b),a(this).data(f.keys.page,c.id),a(f.dom.next_page_button).data(f.keys.page,c.id),a(f.dom.prev_page_button).data(f.keys.page,c.id),a("img",a(this)).load(function(){var b=f.dom.preload+(a(this).parent().hasClass(f.dom.right_page.substr(1))?"1":"0");a(b).bookviewer("preloadPage",d)}),a(this).removeClass("page-unavailable"),c.is_first_page||c.is_last_page?a(this).addClass("page-oob").data("enabled","disabled"):a(this).hasClass("page-oob")&&a(this).removeClass("page-oob").data("enabled","enabled")})},updateAdjacentPageState:function(c,d,e){var f=a.extend(!0,{},b,e||{});return this.each(function(){a(this).data("p",c.id);var b=a(this).data(f.keys.operation);"fwd"===a(this).data(f.keys.operation)&&c.is_last_page?(a(this).addClass("page-oob").removeClass("page-unavailable"),a(this).data("enabled","disabled"),a(this).html("<!-- -->")):"back"===b&&c.is_first_page?(a(this).addClass("page-oob").removeClass("page-unavailable"),a(this).data("enabled","disabled"),a(this).html("<!-- -->")):(a(this).hasClass("page-oob")&&(a(this).removeClass("page-oob"),a(this).data("enabled","enabled")),a(this).addClass("page-unavailable"),a(this).html("page unavailable<br />"+("back"===b?"&lt;&lt; more":"more &gt;&gt;")),a(f.dom.preload+("back"===b?"0":"1")).bookviewer("preloadPage",d,e))})},updatePageNavigation:function(d){var e=d.settings||{},f=a.extend(!0,{},b,e);return this.each(function(){var b=a(f.dom.prev_page_button,a(this)),g=a(f.dom.next_page_button,a(this));d.layout===f.layouts.one_page&&(b.data(f.keys.page,d.gallery.list[0].id),g.data(f.keys.page,d.gallery.list[0].id)),d.gallery.list[0].is_first_page||d.layout!==f.layouts.one_page&&d.gallery.list[1].is_first_page?b.off("click",c.changePage).hide():b.is(":hidden")&&b.on("click",e,c.changePage).show(),d.gallery.list[0].is_last_page||d.layout!==f.layouts.one_page&&d.gallery.list[1].is_last_page?g.off("click",c.changePage).hide():g.is(":hidden")&&g.on("click",e,c.changePage).show()})},setPageSetSize:function(c){var d=a.extend(!0,{},b,c||{});switch(d.layout){case d.layouts.two_page:return this.bookviewer("set2upPageSetSize",c);case d.layouts.one_page:return this.bookviewer("set1upPageSetSize",c);default:return a(d.dom.error_container).littled("displayError","Invalid page layout setting."),void 0}},set2upPageSetSize:function(a){return},set1upPageSetSize:function(c){var d=a.extend(!0,{},b,c||{});return this.each(function(){var b=a(this).find(d.dom.right_page+" img");if(!(b.length<1)){var c=b.width(),e=b.height();c>a(this).width()&&a(this).css("width",c+"px"),e>a(this).height()&&a(this).css("height",e+"px");var f=a(this).closest(d.dom.album_container);f.length>0&&f.width()<c&&a(this).css("margin-left","-"+Math.floor((c-f.width())/2)+"px"),a(this).height()>e&&a(d.dom.right_page,a(this)).css("margin-top",Math.floor((a(this).height()-e)/2)+"px")}})},preloadPage:function(a){return this.css("background","url("+a.full.path+") no-repeat -9999px -9999px")},toggleHeader:function(c,d){var e=a.extend(!0,{},b,d||{});return void 0===c&&(c=1e3),this.each(function(){var b=a(this);setTimeout(function(){b.slideToggle("slow",function(){a(e.dom.minimized_header).show("slow")}).mouseleave(function(){a(this).is(":visible")&&(a(this).slideToggle("slow"),a(e.dom.minimized_header).show("slow"))})},c),a(e.dom.minimized_header).on("mouseenter",function(){a(this).hide("slow",function(){b.is(":hidden")&&b.slideToggle("slow")})})})},keyNavigation:function(c){var d=a.extend(!0,{},b,c.data||{}),e={left:37,up:38,right:39,down:40},f=c.keyCode||c.which;switch(f){case e.left:a(d.dom.page_set+" "+d.dom.prev_page_button).trigger("click");break;case e.right:a(d.dom.page_set+" "+d.dom.next_page_button).trigger("click")}},initScrollbar:function(c){var d=a.extend(!0,{},b,c||{});return this.each(function(){function b(){var a=g.width()-f.width();0>a&&(a=0);var b=a/g.width(),c=f.width()-b*f.width();h.parent().find(".ui-slider-handle").css({width:c,"margin-left":-c/2}),i.width("").width(h.width()-c)}function c(){var a=f.width()-g.width(),b="auto"===g.css("margin-left")?0:parseInt(g.css("margin-left")),c=Math.round(b/a*100);h.slider("value",c)}function e(){var a=g.width()+parseInt(g.css("margin-left")),b=f.width()-a;b>0&&g.css("margin-left",parseInt(g.css("margin-left"))+b)}var f=a(d.dom.scroll_pane,a(this)),g=a(d.dom.scroll_content,a(this));if(!(f.length<0||g.length<0||g.width()<f.width())){var h=a(d.dom.scrollbar,a(this)).slider({slide:function(a,b){g.width()>f.width()?g.css("margin-left",Math.round(b.value/100*(f.width()-g.width()))+"px"):g.css("margin-left",0)}}),i=h.parent().find(".ui-slider-handle").mousedown(function(){h.width(i.width())}).mouseup(function(){h.width("100%")}).append('<span class="ui-icon ui-icon-grip-dotted-vertical"></span>').wrap('<div class="ui-handle-helper-parent"></div>').parent();f.css("overflow","hidden"),a(window).resize(function(){c(),b(),e()}),setTimeout(b,10)}})}};a.fn.bookviewer=function(b){if("extendMethods"===b)a.extend(!0,c,arguments[1]);else{if(c[b])return c[b].apply(this,Array.prototype.slice.call(arguments,1));if("object"==typeof b||!b)return c.init.apply(this,arguments);a.error("Method "+b+" does not exist on jQuery.bookviewer.")}return!1}}(jQuery);